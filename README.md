TODO: use queue to pass messages between threads
